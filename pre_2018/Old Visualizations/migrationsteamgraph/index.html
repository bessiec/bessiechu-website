<!DOCTYPE html>
<meta charset="utf-8">
<head>
<title>Steamgraph of Migration into the United States</title>  

  <script src="https://d3js.org/d3.v2.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Titillium+Web" rel="stylesheet">

    <style>

        body {
          font-family: 'Titillium Web', sans-serif;
          font-weight: 500;
          font-size: 12px;
        }

        .chart { 
          background: #fff;
        }

        p {
          font-family: 'Titillium Web', sans-serif;
          font-size: 14px;
        }


        .axis path, .axis line {
          fill: none;
          stroke: #000;
          stroke-width: 1px;
          shape-rendering: crispEdges;
        }

        button {
          position: absolute;
          right: 50px;
          top: 10px;
        }

      .tooltip {
        line-height: 1;
        font-weight: bold;
        padding: 12px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        border-radius: 2px;
      }


    </style>

</head>

<body>
<h2> Steamgraph representation of the origin countries of migrants into the United States from 1990-2010 </h2>



<div class="chart">
</div>

<script>

    chart("steamgraph_migration.csv");

    var datearray = [];


    function chart(csvpath) {

    var format = d3.time.format("%Y");

    var thousands = d3.format(',')

    var margin = {top: 20, right: 100, bottom: 30, left: 100};
    var width = document.body.clientWidth - margin.left - margin.right;
    var height = 500 - margin.top - margin.bottom;

    var tooltip = d3.select("body")
        .append("div")
        .attr("class", "remove")
        .style("position", "absolute")
        .style("z-index", "20")
        .style("visibility", "hidden")
        .style("top", "30px")
        .style("left", "205px");

    var x = d3.time.scale()
        .range([0, width]);

    var y = d3.scale.linear()
        .range([height-10, 0]);

    var z = d3.scale.category20()

    var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom")
        .ticks(d3.time.year.range, 5);

    var yAxis = d3.svg.axis()
        .scale(y);

    var yAxisr = d3.svg.axis()
        .scale(y);

    var stack = d3.layout.stack()
        .offset("silhouette")
        .values(function(d) { return d.values; })
        .x(function(d) { return d.date; })
        .y(function(d) { return d.value; });

    var nest = d3.nest()
        .key(function(d) { return d.key; });

    var area = d3.svg.area()
        .interpolate("cardinal")
        .x(function(d) { return x(d.date); })
        .y0(function(d) { return y(d.y0); })
        .y1(function(d) { return y(d.y0 + d.y); });

    var svg = d3.select(".chart").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


    var graph = d3.csv(csvpath, function(data) {
      data.forEach(function(d) {
        d.date = format.parse(d.date);
        d.value = +d.value;
      });

      var layers = stack(nest.entries(data));


      x.domain(d3.extent(data, function(d) { return d.date; }));
      y.domain([0, d3.max(data, function(d) { return d.y0 + d.y; })]);

      svg.selectAll(".layer")
          .data(layers)
        .enter().append("path")
          .attr("class", "layer")
          .attr("d", function(d) { return area(d.values); })
          .style("fill", function(d, i) { return z(i); });


      svg.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis);

      svg.append("g")
          .attr("class", "y axis")
          .attr("transform", "translate(" + width + ", 0)")
          .call(yAxis.orient("right"));

      svg.append("g")
          .attr("class", "y axis")
          .call(yAxis.orient("left"));


      svg.selectAll(".layer")
        .attr("opacity", 1)
        .on("mouseover", function(d, i) {
          svg.selectAll(".layer").transition()
          .duration(250)
          .attr("opacity", function(d, j) {
            return j != i ? 0.2 : 1;
        })})
        .on("mousemove", function(d, i) {
          mousex = d3.mouse(this);
          mousex = mousex[0];
          var invertedx = x.invert(mousex);
          invertedx = invertedx.getFullYear();
          var selected = (d.values);
          for (var k = 0; k < selected.length; k++) {
            datearray[k] = selected[k].date
            datearray[k] = datearray[k].getFullYear()
          }

          mousedate = datearray.indexOf(invertedx);
          pro = thousands(d.values[mousedate].value);
          date = format(d.values[mousedate].date);

          d3.select(this)
          .classed("hover", true)
          .attr("stroke", "black")
          .attr("stroke-width", "0.5px"), 
          tooltip.html( "<p><strong> <span style='color:#0080FF'>Path: </strong>" + d.key + "<span style='color:#0080FF'><br><strong>Migrants: </strong></span>" + pro + "<span style='color:#0080FF'><strong><br>Date: </span></strong>" + date).style("visibility", "visible");
          
        })
        .on("mouseout", function(d, i) {
         svg.selectAll(".layer")
          .transition()
          .duration(250)
          .attr("opacity", "1");
          d3.select(this)
          .classed("hover", false)
          .attr("stroke-width", "0px"), tooltip.html( "<strong> <span style='color:#0080FF'><p>" + d.key + "<br>" + d.date + "</p></span></strong>" ).style("visibility", "hidden");
      })
        
      var vertical = d3.select(".chart")
            .append("div")
            .attr("class", "remove")
            .style("position", "absolute")
            .style("z-index", "19")
            .style("width", "1px")
            .style("height", "380px")
            .style("top", "10px")
            .style("bottom", "30px")
            .style("left", "0px")
            .style("background", "#fff");

      d3.select(".chart")
          .on("mousemove", function(){  
             mousex = d3.mouse(this);
             mousex = mousex[0] + 5;
             vertical.style("left", mousex + "px" )})
          .on("mouseover", function(){  
             mousex = d3.mouse(this);
             mousex = mousex[0] + 5;
             vertical.style("left", mousex + "px")});
    });
    }

    </script>


<h3>Quick Observations</h3>
<p>Two trends I noticed from this view of the data at a cursory glance is that the mid-nineties seem to be a big boom for immigration into the United States from a variety of places.  Overall migration shrinks both in terms of absolute numbers the strong representatoin of different countries.  The second piece of this trend might be explained by the dot-com bust and 9/11, a changed economic and political climate that seems to still be resonating today as well as greater prosperity worldwide as the world stabilized after the end of the Cold War.</p>
<p>Less dramatic observations are the ready increase of people arriving from Mexico, China, and India, likely coinciding with the need for labor skills from those countries.  There are also some countries, such as the Phillippines and Vietnam that provide a remarkably consistent and constant flow of migrants, likely due to certain visa programs.</p>

<h3>Credits and Callouts: <h3>
<li>I used <a href="http://bl.ocks.org/WillTurman/4631136">Will Thurman's Interactive Steamgraph block</a> as a base.</li>
<li>Data comes from the <a href="http://www.global-migration.info/">THE GLOBAL FLOW OF PEOPLE</a></li>
<li>Current tooltip implementation isn't ideal since it's a date match, so the tooltip falls away past the year range of the data, which jumps five years per data point.  You need to hover at the date tick marks to see the tooltip values that show country and number of people</li>

  </body>
</html>