<!DOCTYPE html>
<html>
<head> 
  <title>Chinese Emigration 1990-2010</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.6.7/d3-tip.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">

  <style>
    body {
      margin: 0 5% 5% 5%;
      font-family: 'Raleway', sans-serif;
    }

    text {
      fill: #000;
      font-family: 'Raleway', sans-serif;
      font-size: 18px;
      pointer-events: none;
    }

    .node {
      cursor: pointer;
    }

    .node circle {
      stroke: #E80614;
      fill: #a6cee3;
      stroke-width: 1px;
    }

    .node text {
      font-size: 18px;
      font-family: 'Raleway', sans-serif;
    }

    .link {
      fill: none;
      stroke: #1f78b4;
      stroke-width: 2px;
    }

    .d3-tip {
      line-height: 1;
      font-weight: bold;
      font-family: 'Raleway', sans-serif;
      padding: 12px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border-radius: 2px;
    }

    /* Creates a small triangle extender for the tooltip */
    .d3-tip:after {
      box-sizing: border-box;
      display: inline;
      font-size: 10px;
      width: 100%;
      line-height: 1;
      color: rgba(0, 0, 0, 0.8);
      content: "\25BC";
      position: absolute;
      text-align: center;
    }

    /* Style northward tooltips differently */
    .d3-tip.n:after {
      margin: -1px 0 0 0;
      top: 100%;
      left: 0;
    }
  </style>
</head>

<body>
  <h1>Chinese Emigration Destinations 1990-2010</h1>
  <h3>Dataset from <a href="http://www.global-migration.info/">THE GLOBAL FLOW OF PEOPLE</a></h3>
  <p>Click on the white circles to expand. Click again on the now-filled circle to retract. Hover over circles for more info.</p>

  <div id="container"></div>

  <script>
    var minRadius = 2;
    var maxRadius = 25;
    var scale = d3.scale.linear()
      .domain([1, 2000])
      .range([minRadius, maxRadius]);

    var margin = {top: 20, right: 10, bottom: 20, left: 180},
        width = 1560 - margin.right - margin.left,
        height = 1000 - margin.top - margin.bottom;

    var i = 0,
        duration = 750,
        root;

    var tree = d3.layout.tree()
        .size([height, width]);

    var diagonal = d3.svg.diagonal()
        .projection(function(d) { return [d.y, d.x]; });

    var svg = d3.select("#container")
        .append("svg")
        .attr("width", width + margin.right + margin.left)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var tip = d3.tip()
        .attr('class', 'd3-tip')
        .offset([-10, 0])
        .html(function(d) {
          if (d.arrivals === undefined) {
            return "<strong><span style='color:#a6cee3'>" + d.name + "</span></strong>";
          } else if (d.arrivals === 1) {
            return "<strong><span style='color:#a6cee3'>" + d.name + ":</span> <span style='color:#E80614'>" + d.arrivals + "</span> conversion</strong>";
          } else { 
            return "<strong><span style='color:#a6cee3'>" + d.name + ":</span> <span style='color:#E80614'>" + d.arrivals + "</span> arrivals</strong>";
          }
        });

    // Sample data structure (since china_flare.json is not available)
    var sampleData = {
      "name": "China",
      "children": [
        {
          "name": "United States",
          "arrivals": 1200000,
          "children": [
            {"name": "California", "arrivals": 400000},
            {"name": "New York", "arrivals": 300000},
            {"name": "Texas", "arrivals": 150000}
          ]
        },
        {
          "name": "Canada",
          "arrivals": 650000,
          "children": [
            {"name": "Ontario", "arrivals": 350000},
            {"name": "British Columbia", "arrivals": 250000}
          ]
        },
        {
          "name": "Australia",
          "arrivals": 450000,
          "children": [
            {"name": "New South Wales", "arrivals": 200000},
            {"name": "Victoria", "arrivals": 150000}
          ]
        },
        {
          "name": "Japan",
          "arrivals": 250000
        },
        {
          "name": "Singapore",
          "arrivals": 180000
        },
        {
          "name": "United Kingdom",
          "arrivals": 320000
        }
      ]
    };

    // Initialize with sample data
    root = sampleData;
    root.x0 = height / 2;
    root.y0 = 0;

    function collapse(d) {
      if (d.children) {
        d._children = d.children;
        d._children.forEach(collapse);
        d.children = null;
      }
    }

    root.children.forEach(collapse);
    update(root);

    svg.call(tip);

    function update(source) {
      // Compute the new tree layout.
      var nodes = tree.nodes(root).reverse(),
          links = tree.links(nodes);

      // Normalize for fixed-depth.
      nodes.forEach(function(d) { d.y = d.depth * 275; });

      // Update the nodes
      var node = svg.selectAll("g.node")
          .data(nodes, function(d) { return d.id || (d.id = ++i); });

      // Enter any new nodes at the parent's previous position.
      var nodeEnter = node.enter().append("g")
          .attr("class", "node")
          .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
          .on("click", click)
          .on("mouseover", tip.show)
          .on("mouseout", tip.hide);

      nodeEnter.append("circle")
          .attr("r", 2);

      nodeEnter.append("text")
          .attr("x", function(d) { return d.children || d._children ? -15 : 20; })
          .attr("dy", ".35em")
          .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
          .attr("class", "text")
          .text(function(d) { return d.name; })
          .style("fill-opacity", 1);

      // Transition nodes to their new position.
      var nodeUpdate = node.transition()
          .duration(duration)
          .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

      nodeUpdate.select("circle")
          .attr("r", function(d) { 
            if (d.arrivals === undefined)
              return 5;
            else if (d.arrivals > 800000)
              return 20;
            else if (d.arrivals > 500000)
              return 15;
            else if (d.arrivals > 100000)
              return 12;
            else if (d.arrivals > 50000)
              return 10;
            else if (d.arrivals > 5000)
              return 8;
            else
              return scale(Math.sqrt(+d.arrivals));
          })
          .style("fill", function(d) { return d._children ? "#fff" : "#0025A9"; });

      nodeUpdate.select("text")
          .style("fill-opacity", 1);

      // Transition exiting nodes to the parent's new position.
      var nodeExit = node.exit().transition()
          .duration(duration)
          .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
          .remove();

      nodeExit.select("circle")
          .attr("r", 1e-6);

      nodeExit.select("text")
          .style("fill-opacity", 1e-6);

      // Update the links
      var link = svg.selectAll("path.link")
          .data(links, function(d) { return d.target.id; });

      // Enter any new links at the parent's previous position.
      link.enter().insert("path", "g")
          .attr("class", "link")
          .attr("d", function(d) {
            var o = {x: source.x0, y: source.y0};
            return diagonal({source: o, target: o});
          });

      // Transition links to their new position.
      link.transition()
          .duration(duration)
          .attr("d", diagonal);

      // Transition exiting nodes to the parent's new position.
      link.exit().transition()
          .duration(duration)
          .attr("d", function(d) {
            var o = {x: source.x, y: source.y};
            return diagonal({source: o, target: o});
          })
          .remove();

      // Stash the old positions for transition.
      nodes.forEach(function(d) {
        d.x0 = d.x;
        d.y0 = d.y;
      });
    }

    // Toggle children on click.
    function click(d) {
      if (d.children) {
        d._children = d.children;
        d.children = null;
      } else {
        d.children = d._children;
        d._children = null;
      }
      update(d);
    }
  </script>
</body>
</html>